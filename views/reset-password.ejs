<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>비밀번호 재설정</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .hidden {
      display: none;
    }

    body {
      background: #f5f6f8;
      font-family: 'Noto Sans KR', 'Inter', sans-serif;
      color: #111;
    }

    .board-container {
      max-width: 600px;
      margin: 80px auto;
      background: #fff;
      border-radius: 20px;
      padding: 32px;
      border: 1px solid #f0f0f0;
      color: #111;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .btn-modern {
      background: #f1f3f5;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 500;
      color: #111;
      transition: background 0.2s ease-in-out;
      width: 100%;
    }

    .btn-modern:hover {
      background: #e9ecef;
      color: #111;
    }

    .form-control {
      border-radius: 12px;
      padding: 10px 14px;
      border: 1px solid #dee2e6;
    }

    .form-control:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    h4 {
      font-weight: 600;
      color: #111;
      margin-bottom: 16px;
    }

    p {
      color: #555;
    }

    .d-none {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="board-container">
    <h4>비밀번호 재설정</h4>

    <!-- 1️⃣ 이메일 입력 -->
    <form id="emailForm">
      <p>가입하신 <strong>이메일</strong>을 입력해주세요.</p>
      <input class="form-control mb-3" type="email" id="email" name="email" placeholder="example@naver.com" required>
      <button class="btn-modern" type="submit">인증 코드 보내기</button>
    </form>

    <!-- 2️⃣ 인증 코드 확인 -->
    <form id="verifyForm" class="mt-4 d-none">
      <p>이메일로 전송된 <strong>인증 코드</strong>를 입력해주세요.</p>
      <input class="form-control mb-3" type="text" id="code" name="code" placeholder="인증 코드" required>
      <button class="btn-modern" type="submit">인증 확인</button>
    </form>

    <!-- 3️⃣ 새 비밀번호 입력 -->
    <form id="resetForm" class="hidden mt-4">
      <p><strong>새 비밀번호</strong>를 입력해주세요.</p>
      <input class="form-control mb-3" type="password" id="newPassword" name="newPassword" placeholder="새 비밀번호"
        required>
      <button class="btn-modern" type="submit">비밀번호 변경</button>
    </form>

  </div>

  <script>
    const emailForm = document.getElementById('emailForm');
    const verifyForm = document.getElementById('verifyForm');
    const resetForm = document.getElementById('resetForm');

    let userEmail = '';

    // 1️⃣ 인증코드 요청
    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      userEmail = document.getElementById('email').value.trim();
      if (!userEmail) return alert('이메일을 입력해주세요.');

      const res = await fetch('/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail })
      });
      const data = await res.json();

      if (data.success) {
        alert('인증 코드가 이메일로 전송되었습니다.');
        emailForm.classList.add('d-none');
        verifyForm.classList.remove('d-none');
      } else {
        alert('등록된 이메일이 없습니다.');
      }
    });

    // 2️⃣ 인증코드 검증
    verifyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = document.getElementById('code').value.trim();

      const res = await fetch('/verify-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail, code })
      });
      const data = await res.json();

      if (data.success) {
        alert('인증이 완료되었습니다.');
        verifyForm.classList.add('hidden');  // 인증폼 숨김
        resetForm.classList.remove('hidden'); // 비번 변경폼 표시
      } else {
        alert('인증 코드가 올바르지 않습니다.');
      }
    });

    // 3️⃣ 비밀번호 재설정
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPassword = document.getElementById('newPassword').value.trim();

      const res = await fetch('/reset-password-new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail, newPassword })
      });
      const data = await res.json();

      if (data.success) {
        alert('비밀번호가 성공적으로 변경되었습니다.');
        window.location.href = '/login';
      } else {
        alert('비밀번호 변경 중 오류가 발생했습니다.');
      }
    });
  </script>
</body>

</html>